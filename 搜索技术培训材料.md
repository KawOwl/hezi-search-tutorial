# 搜索技术培训材料

---

## 第1页：搜索过程概览

### 🔍 **搜索系统整体架构**

```
用户输入 → 预处理 → 查询理解 → 召回 → 排序 → 结果返回
```

### **1. 预处理阶段**
- **输入过滤**：去除禁用词、特殊字符、拼音识别
  - *示例*：`"apple苹果手机！！！"` → `"apple苹果手机"`
- **分词处理**：使用动态词典进行分词，支持新词自动识别
  - *示例*：`"苹果手机"` → `["苹果", "手机"]`
<!-- - **查询规范化**：去除括号内容、标准化输入格式
  - *示例*：`"iPhone 15（Pro Max版本）"` → `"iPhone 15"` -->

### **2. 查询理解阶段**
- **命名实体识别**：识别品牌、类目、属性、标签等实体
  - *示例*：`"苹果手机"` → 品牌:`"苹果"`, 类目:`"手机"`
- **精准匹配**：直接匹配系统中已有的品牌和类目
  - *示例*：`"华为"` → 精确匹配到品牌库中的`brandId: "huawei"`
- **同义词扩展**：使用同义词库扩展未直接匹配的类目
  - *示例*：`"笔记本"` → 扩展为`["笔记本电脑", "便携式电脑", "laptop"]`
- **向量搜索扩展**：基于语义向量进行品牌和类目扩展
  - *示例*：`"游戏本"` → 语义相似:`["电竞笔记本", "高性能笔记本"]`，相似度:`0.85`

### **3. 评分与召回阶段**
- **多因子联合评分**：综合考虑实体关系、用户偏好、平台热度
  - *示例*：`"苹果手机"` → 品牌权重:`2.0` × 类目权重:`1.5` = 联合评分:`3.5`
- **得分归一化**：使用对数缩放等方法归一化不同维度的分数
  - *示例*：销量`10000`件 → 归一化后:`0.85`分（0-1区间）
- **ES粗排召回**：使用BM25算法结合业务权重进行初步召回
  - *示例*：BM25评分:`12.5` + 语义增强:`3.2` + 质量评分:`1.8` = 总分:`17.5`

### **4. 精排阶段**
- **业务模型精排**：综合BM25、语义增强、商品质量等多维度评分
- **多级排序逻辑**：按优先级顺序比较，只有相等时才比较下一个维度
  - *示例排序过程*（默认顺序：`first,OBB,SEM,PQ,VSL,PR`）：
    - 商品A：ES评分`17.5`，品牌加权`2.0`，语义增强`3.2`
    - 商品B：ES评分`17.5`，品牌加权`1.5`，语义增强`3.8`
    - **第1级比较**：ES评分相等(17.5) → 继续下一级
    - **第2级比较**：品牌加权A(2.0) > B(1.5) → **商品A排在前面**
    - 注意：即使商品B的语义增强更高，由于品牌加权已经决出胜负，不再比较后续维度
- **分页返回**：根据用户需求返回相应页码的结果
  - *示例*：用户请求第2页，每页20条 → 返回第21-40条结果

### **关键组件**
- **Elasticsearch**：核心搜索引擎，负责倒排索引和BM25评分
  - *作用*：存储商品索引，执行全文搜索，返回相关性评分
- **Prisma ORM**：数据库操作，管理商品、品牌、类目等基础数据
  - *作用*：查询品牌信息、类目层级、商品属性等结构化数据
- **缓存系统**：多层缓存优化性能（搜索缓存、排序缓存、实体缓存）
  - *示例*：热门搜索`"iPhone"`结果缓存5分钟，避免重复计算
- **日志系统**：完整的搜索日志记录和性能监控
  - *记录内容*：搜索词、响应时间、召回数量、点击率等指标

### 💡 **完整搜索示例流程**

**用户输入**: `"华为笔记本电脑"`

1. **预处理**: `"华为笔记本电脑"` → `["华为", "笔记本电脑"]`
2. **实体识别**: 品牌=`"华为"`, 类目=`"笔记本电脑"`
3. **评分计算**: 品牌匹配度`2.0` + 类目匹配度`1.5` + BM25评分`8.3`
4. **召回结果**: 300件相关商品（动态缓存扩展）
5. **精排输出**: 按综合评分排序，返回前20件商品
6. **响应时间**: 总耗时`120ms`（ES查询`80ms` + 业务逻辑`40ms`）

---

## 第2页：搜索评分体系

### 🎯 **评分体系架构**

```
最终评分 = BM25评分 × 权重配置 + 语义增强评分 + 商品质量评分 + 品牌提升评分
```

### **1. BM25基础评分**
- **算法原理**：TF-IDF的改进版本，考虑词频饱和度
- **归一化处理**：使用对数缩放避免长尾效应
```typescript
// TitleBM25归一化脚本
double total = Math.log1p(_score/k) / Math.log1p(xmax/k);
return total * weight;
```

### **2. 语义增强评分 (SemanticEnhancement)**
**权重分布**：
- **品牌匹配**：权重2.0，精确匹配品牌名称
- **类目匹配**：权重1.5，前台类目和后台类目
- **规格匹配**：权重1.0，产品规格和属性

**计算公式**：
```painless
total = brand_score * brand_weight + 
        catF_score * category_weight + 
        catR_score * category_weight
```

### **3. 商品质量评分 (ProductQuality)**
**销售数据权重分布**：
- **近30天销量**：60%权重（反映当前热度）
- **近365天销量**：30%权重（反映稳定性）
- **历史总销量**：10%权重（反映经典程度）

**计算公式**：
```typescript
skuScore = (sku30 * 0.6) + (sku365 * 0.3) + (skuTotal * 0.1)
normalizedScore = Math.log1p(skuScore/k) / Math.log1p(xmax/k)
```

### **4. 品牌提升评分 (OriginalBrandBoost)**
**店铺信誉评分**：
- **官方店铺**：+0.5分
- **旗舰店铺**：+0.2分
- **品牌匹配**：+1.0分（店铺名包含搜索品牌）

### **5. 供应商星级评分 (VenderStarLevel)**
- **1-5星评级**：直接使用供应商星级作为权重
- **优质标签**：带有"premium"标签的商品额外加权

### **6. 业务权重评分 (BusinessWeight)**
**测试模式权重**：
```typescript
testWeight.brand + testWeight.product + testWeight.shop + 
testWeight.vender + testWeight.categoryFront + testWeight.categoryRaw
```

**正式模式权重**：
```typescript
formalWeight.brand + formalWeight.product + formalWeight.shop + 
formalWeight.vender + formalWeight.categoryFront + formalWeight.categoryRaw
```

---

## 第3页：搜索粗排和精排

### ⚡ **粗排阶段 (Elasticsearch层面)**

### **1. Function Score查询**
```typescript
{
  function_score: {
    query: { /* BM25基础查询 */ },
    functions: [
      { script_score: { script: semanticEnhancementScript } },
      { script_score: { script: originalBrandBoostScript } },
      { script_score: { script: productQualityScoreScript } },
      { script_score: { script: titleBM25NormalizerScript } },
      { script_score: { script: businessWeightScript } }
    ],
    score_mode: "sum",     // 评分合并方式：相加
    boost_mode: "replace"  // 替换原始BM25评分
  }
}
```

### **2. 粗排召回策略**
- **动态缓存扩展**：基于当前缓存状态和分页需求动态扩展召回数量
  - 缓存充足时：直接使用缓存结果，无需额外查询
  - 缓存不足时：计算扩展数量 `expandSize = max(需求数量 - 当前缓存, 0)`
  - 最大限制：单次查询不超过10000条，避免性能问题
- **分页计算**：`paginationEnd = max(from + size, esRecallSize)`
- **过滤条件**：品牌、类目、价格、库存等业务过滤

### **3. SPU/SKU处理**
**SPU模式**：
- 使用`collapse`功能按`spuId`去重
- 聚合统计：`distinct_spu_count`获取真实SPU数量
- 属性聚合：收集可筛选的商品属性

**SKU模式**：
- 直接返回所有SKU结果
- 支持同一SPU下多个SKU的展示

---

### 🎯 **精排阶段 (应用层面)**

### **1. 排序器架构**
```typescript
const sorterMap = {
  first: byScore(),           // ES评分排序
  OBB: byOriginalBrandBoost(), // 品牌提升排序
  SEM: bySemanticEnhancement(), // 语义增强排序
  PQ: byProductQuality(),      // 商品质量排序
  VSL: byVenderStarLevel(),    // 供应商星级排序
  PR: byPremium()             // 优质标签排序
}
```

### **2. 排序顺序配置**
**默认排序**：`"first,OBB,SEM,PQ,VSL,PR"`
- **first**：ES综合评分（主排序）
- **OBB**：品牌店铺权重
- **SEM**：语义匹配度
- **PQ**：商品销售质量
- **VSL**：供应商信誉
- **PR**：优质商品标识

### **3. 多级排序逻辑**
```typescript
// 多级排序核心逻辑：按优先级逐级比较，只有相等才比较下一级
const createSorter = (comparators) => {
  return (a, b) => {
    const [current, ...rest] = comparators;
    if (!current) return 0;
    
    const result = current(a, b);
    // 关键：只有当前维度相等(result === 0)时，才比较下一个维度
    return result !== 0 ? result : createSorter(rest)(a, b);
  };
};

function sorter(sortType, products, sorterOrder) {
  const order = sorterOrder.split(','); // ["first", "OBB", "SEM", "PQ", "VSL", "PR"]
  const comparators = order.map(key => sorterMap[key]);
  
  return products.sort(createSorter(comparators));
}
```

**排序优先级说明**：
- **第1优先级**：ES综合评分 (`first`)
- **第2优先级**：品牌店铺权重 (`OBB`) - 只有ES评分相同时才比较
- **第3优先级**：语义匹配度 (`SEM`) - 只有前两项都相同时才比较
- **后续优先级**：依此类推...

### **4. 分组排序策略**
```typescript
// 货架式排序：先分组，组内按排序器配置排序
function divideGroup(list, compareFn, groupSize) {
  const groups = [];
  for (let i = 0; i < list.length; i += groupSize) {
    groups.push(list.slice(i, i + groupSize));
  }
  return groups.map(group => group.sort(compareFn));
}
```

---

## 第4页：搜索设置解释及调整方法

### ⚙️ **核心配置参数**

### **1. 权重配置 (Weight Configuration)**

#### **语义增强权重**
```typescript
semanticEnhancementScriptBrandWeight: 2.0      // 品牌匹配权重
semanticEnhancementScriptCategoryWeight: 1.5   // 类目匹配权重  
semanticEnhancementScriptResultWeight: 5.0     // 语义增强总权重
```
**调整建议**：
- 品牌导向平台：提高`brandWeight`到3.0
- 类目丰富平台：提高`categoryWeight`到2.0
- 降低语义干扰：减少`resultWeight`到3.0

#### **其他脚本权重**
```typescript
titleBM25NormalizerScriptResultWeight: 5.0     // 标题BM25权重
originalBrandBoostScriptResultWeight: 1.0      // 品牌店铺权重
productQualityScoreScriptResultWeight: 1.0     // 商品质量权重
productQualityCoefficient: 1.0                 // 质量系数
categoryCoefficient: 1.0                       // 类目系数
```

### **2. 归一化参数 (Normalization Parameters)**

#### **对数缩放配置**
```typescript
// 标题BM25归一化
titleBM25Normalizer: { xmax: 100, k: 10 }
// 语义增强归一化  
semanticEnhancement: { xmax: 50, k: 5 }
// 商品质量归一化
productQualityScore: { xmax: 1000, k: 100 }
```

**参数说明**：
- **xmax**：最大期望值，用于归一化上限
- **k**：缩放因子，控制曲线陡峭程度
- **公式**：`Math.log1p(score/k) / Math.log1p(xmax/k)`

**调整策略**：
- 降低k值：增加低分商品的权重
- 提高xmax：降低高分商品的优势
- 平台数据特点：根据实际分数分布调整

### **3. 召回配置 (Recall Configuration)**

```typescript
esRecallSize: 300                          // ES召回窗口大小
cardinalityPrecisionThreshold: 40000       // 基数统计精度阈值
sorterOrder: "first,OBB,SEM,PQ,VSL,PR"    // 排序优先级
```

**动态缓存扩展机制**：
```typescript
// 核心逻辑：基于当前缓存和分页需求动态计算扩展
const currentSize = cache?.products?.length || 0;
const paginationEnd = Math.max(from + size, esRecallSize);
const expandSize = Math.max(Math.min(Math.max(paginationEnd - currentSize, 0), 10000 - currentSize), 0);

// 缓存命中条件
if (currentSize >= paginationEnd && useCache) {
  return cache; // 直接使用缓存
} else {
  // 增量查询：from = currentSize, size = expandSize
  expandPagination = { from: Math.min(currentSize, 10000), size: expandSize };
}
```

**调整指南**：
- **小流量平台**：`esRecallSize: 150`减少计算开销
- **大流量平台**：`esRecallSize: 500`提高排序精度
- **品牌为主**：调整sorterOrder为`"first,OBB,PQ,SEM,VSL,PR"`
- **销量为主**：调整sorterOrder为`"first,PQ,OBB,SEM,VSL,PR"`

### **4. 业务权重调整 (Business Weight Tuning)**

#### **实体权重设置**
在数据库中每个实体都有测试权重和正式权重：
```sql
-- 品牌权重调整
UPDATE Brand SET testValue = 2.0 WHERE brandId = 'target_brand';
-- 类目权重调整  
UPDATE CategoryFront SET testValue = 1.5 WHERE categoryId = 'target_category';
-- 商品权重调整
UPDATE Product SET testWeight_product = 1.8 WHERE productId = 'target_product';
```

#### **权重调整工具**
通过管理界面调整：
- **搜索设置页面**：`/project/[code]/search/setting`
- **实体库页面**：`/project/[code]/entityLibrary`
- **权重范围**：0.1 - 5.0

### **5. 性能优化配置**

#### **缓存设置**
```typescript
searchCache: TTL 5分钟      // 搜索结果缓存
sortCache: TTL 10分钟       // 排序结果缓存  
esCache: TTL 1分钟          // ES查询缓存
```

#### **分页优化**
```typescript
// 大分页优化
if (page > 100) {
  useScrollSearch = true;
  scrollTTL = "5m";
}
```

### **6. A/B测试建议**

#### **权重对比测试**
```typescript
// 测试组配置
const testConfig = {
  semanticEnhancementWeight: 3.0,  // vs 基线5.0
  brandBoostWeight: 2.0,           // vs 基线1.0
  qualityWeight: 0.5               // vs 基线1.0
};
```

#### **排序策略测试**
- **策略A**：`"first,SEM,OBB,PQ,VSL,PR"` (语义优先)
- **策略B**：`"first,PQ,OBB,SEM,VSL,PR"` (销量优先)  
- **策略C**：`"first,OBB,SEM,PQ,VSL,PR"` (品牌优先)

#### **监控指标**
- **点击率 (CTR)**：结果页面点击率
- **转化率 (CVR)**：搜索到购买的转化率
- **搜索成功率**：有结果的搜索占比
- **用户满意度**：通过用户反馈收集

---

### 💡 **调优最佳实践**

1. **渐进式调整**：每次只调整一个参数，观察效果
2. **数据驱动**：基于搜索日志和用户行为数据调整
3. **AB测试**：对比不同配置的业务指标
4. **定期评估**：根据商品和用户变化定期调整权重
5. **监控告警**：设置搜索质量监控和异常告警
